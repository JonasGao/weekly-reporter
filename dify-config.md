# Dify 工作流配置参考

## 工作流设计

### 节点配置

#### 1. 开始节点 (Start)
**输入变量定义：**

| 变量名 | 类型 | 描述 | 必需 |
|--------|------|------|------|
| prev_week_plan | Text | 上周计划内容 | 是 |
| prev_week_work | Text | 上周实际工作 | 是 |
| curr_week_plan | Text | 下周计划内容 | 是 |
| prev_week_additional_notes | Text | 上周工作额外说明 | 否 |

#### 2. LLM 节点配置

**模型选择：**
- 推荐：GPT-4、Claude-3.5-Sonnet、或其他高质量大模型
- 温度：0.1-0.3 (保证输出稳定性)
- 最大令牌数：2000-4000

**系统提示词：**
```
你是一个专业的工作秘书，专门帮助用户整理和生成规范的工作周报。

请根据用户提供的四项输入数据，生成一份结构清晰、内容完整的工作周报。

输出格式要求：
1. 本周工作内容（表格形式，包含：所属项目、工作项、工作内容及进度说明）
2. 下周工作计划（表格形式，包含：所属项目、工作项、计划内容）  
3. 本周工作总结（文字描述，简明扼要）

注意事项：
- 严格按照用户提供的原始数据进行整理，不添加主观判断
- 确保表格格式规范，使用 Markdown 表格语法
- 工作总结要基于计划与实际完成情况的对比
- 保持语言简洁专业，符合商务写作规范
```

**用户消息模板：**
```
请基于以下信息生成工作周报：

上周工作计划：
{{prev_week_plan}}

上周工作内容：
{{prev_week_work}}

下周工作计划：
{{curr_week_plan}}

上周工作额外说明：
{{prev_week_additional_notes}}
```

#### 3. 结束节点 (End)
**输出变量：**
- `result`: LLM 生成的完整周报内容

### 工作流连接
```
开始节点 → LLM节点 → 结束节点
```

## API 调用示例

### 请求格式
```javascript
const response = await fetch('https://api.dify.ai/v1/workflows/run', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer app-xxxxxxxxxxxxxxxx',
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        inputs: {
            "prev_week_plan": "项目A | 需求分析 | 完成用户需求调研和分析",
            "prev_week_work": "项目A | 需求分析 | 已完成80%，完成用户访谈和需求文档草稿", 
            "curr_week_plan": "项目A | 原型设计 | 根据需求文档设计交互原型",
            "prev_week_additional_notes": "进度略有延迟，需要更多时间完善需求文档"
        },
        response_mode: "blocking",
        user: "weekly-reporter-user"
    })
});
```

### 响应格式
```json
{
    "workflow_run_id": "djflajgkldjgd",
    "task_id": "9da23599-e713-473b-982c-4328d4f5c78a",
    "data": {
        "id": "fdlsjfjejgkdjg",
        "workflow_id": "fljslkfjlskdjflkjdkljgs",
        "status": "succeeded",
        "outputs": {
            "result": "## 本周工作内容\n\n| 所属项目 | 工作项 | 工作内容及进度说明 |\n|---------|--------|------------------|\n| 项目A | 需求分析 | 已完成80%，完成用户访谈和需求文档草稿 |\n\n..."
        },
        "error": null,
        "elapsed_time": 2.8,
        "total_tokens": 1200,
        "created_at": 1703128473
    }
}
```

### Think 内容处理
前端工具会自动识别并移除以下格式的 think 内容：
- `<think>...</think>` - XML 标签格式
- `{{think}}...{{/think}}` - 双花括号格式
- `[think]...[/think]` - 方括号格式
- ````think...```` - Markdown 代码块格式
- `<THINK>...</THINK>` - 大写标签格式

这样确保最终展示给用户的周报内容干净整洁，不包含 AI 的思考过程。

## 高级配置

### 条件分支处理
如果需要根据输入内容的不同，采用不同的处理逻辑，可以添加条件节点：

```
开始节点 → 条件节点 → [多个LLM节点] → 结束节点
```

**条件示例：**
- 如果"上周工作额外说明"包含"延迟"关键词，使用特殊的提示词处理
- 如果工作项目数量超过5个，使用更详细的分析模板

### 多轮对话优化
对于复杂的周报生成需求，可以设计多轮处理：

1. **第一轮**：基础内容分析和整理
2. **第二轮**：格式优化和质量检查
3. **第三轮**：最终润色和输出

### 错误处理
在 LLM 节点后添加条件检查节点，验证输出质量：

- 检查是否包含必需的表格结构
- 验证内容完整性
- 格式规范性检查

### 预期输出格式
```markdown
## 本周工作内容

| 所属项目 | 工作项 | 工作内容及进度说明 |
|---------|--------|------------------|
| 项目A | 需求分析 | 已完成80%，完成用户访谈和需求文档草稿 |
| 项目B | 代码开发 | 已完成100%，登录模块已上线测试 |

## 下周工作计划

| 所属项目 | 工作项 | 计划内容 |
|---------|--------|----------|
| 项目A | 原型设计 | 根据需求文档设计交互原型 |
| 项目C | 测试验收 | 进行功能测试和用户验收 |

## 本周工作总结

本周主要完成了两个核心项目的关键任务。项目A的需求分析进度良好，已完成80%的工作量，用户访谈和需求文档草稿已完成，为下周的原型设计奠定了基础。项目B的代码开发任务提前完成，登录模块已成功上线测试，获得积极反馈。整体而言，本周工作进展顺利，项目B超额完成预期目标，项目A虽有轻微延迟但仍在可控范围内。下周将重点推进项目A的原型设计和项目C的测试验收工作。
```

## 性能优化建议

1. **缓存机制**：对于相似的输入，可以实现简单的缓存
2. **批量处理**：如果需要处理多份周报，可以设计批量处理工作流
3. **异步处理**：对于大量数据，考虑使用异步响应模式
4. **成本控制**：监控 token 使用量，优化提示词长度

## 监控和调试

### 关键指标
- 响应时间
- Token 消耗
- 成功率
- 输出质量

### 日志记录
- 输入数据记录
- 处理时间记录
- 错误信息记录
- 用户反馈记录
