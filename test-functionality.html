<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试页面</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            border-left: 4px solid #27ae60;
        }
    </style>
</head>
<body>
    <h1>智能周报生成工具 - 功能测试</h1>
    
    <div class="test-section">
        <h2>配置区域折叠功能测试</h2>
        <p>测试配置区域的展开/折叠功能以及状态持久化。</p>
        <button class="test-button" onclick="testConfigCollapse()">测试配置折叠</button>
        <button class="test-button" onclick="testConfigPersistence()">测试状态持久化</button>
        <div id="configTestResult" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>加载覆盖层功能测试</h2>
        <p>测试全屏加载覆盖层的显示、隐藏和取消功能。</p>
        <button class="test-button" onclick="testLoadingOverlay()">测试加载覆盖层</button>
        <button class="test-button" onclick="testLoadingCancel()">测试取消功能</button>
        <div id="loadingTestResult" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>集成测试</h2>
        <p>测试整体功能的集成情况。</p>
        <button class="test-button" onclick="testIntegration()">运行集成测试</button>
        <div id="integrationTestResult" class="test-result" style="display: none;"></div>
    </div>

    <script>
        // 加载主应用的脚本
        const script = document.createElement('script');
        script.src = 'script.js';
        document.head.appendChild(script);

        function showTestResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.style.borderLeftColor = isSuccess ? '#27ae60' : '#e74c3c';
            element.innerHTML = `<strong>${isSuccess ? '✅ 成功' : '❌ 失败'}:</strong> ${message}`;
        }

        function testConfigCollapse() {
            try {
                // 检查是否存在 ConfigurationSection 类
                if (typeof ConfigurationSection !== 'undefined') {
                    const configSection = new ConfigurationSection();
                    
                    // 测试折叠功能
                    const initialState = configSection.isCollapsed;
                    configSection.toggle();
                    const afterToggle = configSection.isCollapsed;
                    
                    if (initialState !== afterToggle) {
                        showTestResult('configTestResult', '配置折叠功能正常工作，状态切换成功');
                    } else {
                        showTestResult('configTestResult', '配置折叠功能可能存在问题，状态未发生变化', false);
                    }
                } else {
                    showTestResult('configTestResult', 'ConfigurationSection 类未找到，请检查脚本加载', false);
                }
            } catch (error) {
                showTestResult('configTestResult', `测试出错: ${error.message}`, false);
            }
        }

        function testConfigPersistence() {
            try {
                // 清除现有状态
                localStorage.removeItem('weeklyReporter_configCollapsed');
                
                // 创建实例并测试状态保存
                const configSection = new ConfigurationSection();
                configSection.isCollapsed = true;
                configSection.saveState();
                
                // 创建新实例并检查状态是否恢复
                const newConfigSection = new ConfigurationSection();
                
                if (newConfigSection.isCollapsed === true) {
                    showTestResult('configTestResult', '配置状态持久化功能正常，状态正确保存和恢复');
                } else {
                    showTestResult('configTestResult', '配置状态持久化功能可能存在问题', false);
                }
            } catch (error) {
                showTestResult('configTestResult', `持久化测试出错: ${error.message}`, false);
            }
        }

        function testLoadingOverlay() {
            try {
                if (typeof LoadingOverlay !== 'undefined') {
                    const loadingOverlay = new LoadingOverlay();
                    
                    // 测试显示
                    loadingOverlay.show('测试消息', () => {
                        console.log('取消回调被调用');
                    });
                    
                    // 2秒后隐藏
                    setTimeout(() => {
                        loadingOverlay.hide();
                        showTestResult('loadingTestResult', '加载覆盖层显示和隐藏功能正常');
                    }, 2000);
                    
                } else {
                    showTestResult('loadingTestResult', 'LoadingOverlay 类未找到，请检查脚本加载', false);
                }
            } catch (error) {
                showTestResult('loadingTestResult', `加载覆盖层测试出错: ${error.message}`, false);
            }
        }

        function testLoadingCancel() {
            try {
                if (typeof LoadingManager !== 'undefined') {
                    const loadingManager = new LoadingManager();
                    
                    // 测试取消功能
                    const controller = loadingManager.show(() => {
                        showTestResult('loadingTestResult', '取消功能正常，回调被正确触发');
                    });
                    
                    // 1秒后模拟取消
                    setTimeout(() => {
                        loadingManager.cancel();
                    }, 1000);
                    
                } else {
                    showTestResult('loadingTestResult', 'LoadingManager 类未找到，请检查脚本加载', false);
                }
            } catch (error) {
                showTestResult('loadingTestResult', `取消功能测试出错: ${error.message}`, false);
            }
        }

        function testIntegration() {
            try {
                // 等待脚本加载完成
                setTimeout(() => {
                    if (typeof WeeklyReporter !== 'undefined') {
                        // 检查主应用是否正确初始化了新功能
                        const reporter = new WeeklyReporter();
                        
                        let results = [];
                        
                        // 检查配置折叠功能
                        if (reporter.configSection && typeof reporter.configSection.toggle === 'function') {
                            results.push('✅ 配置折叠功能已集成');
                        } else {
                            results.push('❌ 配置折叠功能未正确集成');
                        }
                        
                        // 检查加载管理器
                        if (reporter.loadingManager && typeof reporter.loadingManager.show === 'function') {
                            results.push('✅ 加载管理器已集成');
                        } else {
                            results.push('❌ 加载管理器未正确集成');
                        }
                        
                        showTestResult('integrationTestResult', results.join('<br>'));
                    } else {
                        showTestResult('integrationTestResult', 'WeeklyReporter 类未找到，请检查主应用脚本', false);
                    }
                }, 500);
                
            } catch (error) {
                showTestResult('integrationTestResult', `集成测试出错: ${error.message}`, false);
            }
        }

        // 页面加载完成后自动运行简单测试
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('开始自动功能检测...');
                
                // 检查必要的类是否存在
                const classes = ['ConfigurationSection', 'LoadingOverlay', 'LoadingManager', 'WeeklyReporter'];
                classes.forEach(className => {
                    if (typeof window[className] !== 'undefined') {
                        console.log(`✅ ${className} 类已正确加载`);
                    } else {
                        console.log(`❌ ${className} 类未找到`);
                    }
                });
            }, 1000);
        });
    </script>
</body>
</html>